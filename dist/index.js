(()=>{function de(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return alert("AudioContext not supported");navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t||alert("getUserMedia is not implemented in this browser"),new Promise(function(n,s){t.call(navigator,e,n,s)})})}var S=(e,...t)=>{e.classList.remove(...t),e.offsetWidth,e.classList.add(...t)};var me=440,pe=69,ke=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function fe(e){let t=De(e);return{value:t%12,index:t,name:ke[t%12],cents:Pe(e,t),octave:Math.floor(t/12)-1,frequency:e}}function De(e){let t=12*(Math.log(e/me)/Math.log(2));return Math.round(t)+pe}function Ue(e){return me*2**((e-pe)/12)}function Pe(e,t){return Math.floor(1200*Math.log(e/Ue(t))/Math.log(2))}function Ge(e){return{[Symbol.iterator](){return e}}}function*ye(e,t=(n,s)=>n===s){let n=e[Symbol.iterator](),{done:s,value:a}=n.next();if(s)return;let d=[a],m=a;for(let l of Ge(n))t(l,m)?d.push(l):(yield d,d=[l]),m=l;yield d}function*ge(e,t){for(let n of e)if(t(n))yield n;else break}var ve=e=>[].concat(...e),Ee=(e,t)=>(e==null||e.pop(),e==null||e.unshift(t),e);var xe=(e,t,n)=>e.reduce((s,a)=>n(a,t)<n(s,t)?a:s);var j=(e,t,n)=>e&&(e[t]=n),q=e=>!!e;function D(e,t){return new Promise(n=>e.addEventListener(t,n,{once:!0}))}var N=e=>new Promise(t=>setTimeout(t,e));var be=(e,t)=>{let n=!1,s;return(...a)=>{s=a,n||(t(...a),n=!0,setTimeout(()=>{n=!1,t(...s)},e))}};var he=(e,t=1)=>Math.round(e/t)*t,Me=e=>Math.max(0,Math.min(1,e));console.log("Licensed under AGPL-3.0: https://github.com/onlinemictest/violin-tuner");var Ne=8192,Xe=185,Ve=3500,He=15,Re=5,$e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],Fe=[1,2,3,4,5,6,7,8],we=ve(Fe.map(e=>$e.map(t=>`${t}_${e}`))),P={G_3:195.9977,D_4:293.6648,A_4:440,E_5:659.2551},f=Object.keys(P),U=500,L={X:"translateX",Y:"translateY"},Ye=e=>e?xe(f,e,(t,n)=>Math.abs(we.indexOf(t)-we.indexOf(n))):void 0;de();var je=e=>e[0]!==void 0,K=3,qe=e=>t=>t[0]!==e||t[0]===e&&t.length<=K;if(!("WebAssembly"in window)||!("AudioContext"in window)||!("createAnalyser"in AudioContext.prototype)||!("createScriptProcessor"in AudioContext.prototype)){if(!("WebAssembly"in window))throw alert("Browser not supported: 'WebAssembly' is not defined");if(!("AudioContext"in window))throw alert("Browser not supported: 'AudioContext' is not defined");if(!("createAnalyser"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createAnalyser' is not defined");if(!("createScriptProcessor"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createScriptProcessor' is not defined")}var Ke="animate"in Element.prototype?e=>e.animate([{transform:"translateY(10vw) scale(0.33)"},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>S(e,"blob-animation"),We="animate"in Element.prototype?e=>e.animate([{transform:"translateY(-10vw) scale(3) "},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>S(e,"shrink-animation");Aubio().then(({Pitch:e})=>{let t=document.getElementById("violin-tuner"),n=document.getElementById("audio-start"),s=document.getElementById("audio-pause"),a=document.getElementById("tune-up-text"),d=document.getElementById("tune-down-text"),m=document.getElementById("circle-text-play"),l=document.getElementById("circle-text-pluck"),w=document.getElementById("circle-text-complete"),T=document.getElementById("circle-text-error"),i=document.getElementById("circle-note"),y=document.getElementById("match-circle-l"),W=document.getElementById("match-circle-r"),g=document.getElementById("inner-circle"),x=document.getElementById("tuned-jingle");x.volume=.001;let Te=.5,G=new Map(Object.keys(P).map(r=>[r,document.getElementById(r)])),C=new Map(Object.keys(P).map(r=>[r,document.getElementById(`${r}-fill`)]));if(!t||!n||!s||!a||!d||!m||!l||!w||!T||!i||!y||!W||!g||!x||![...G.values()].every(q)||![...C.values()].every(q))return console.log(t,n,s,a,d,m,l,w,T,i,y,W,g,x,[...G.values()],[...C.values()]),alert("Expected HTML element missing");let B=be(500,(r,E)=>{r?(a.classList.remove("show"),d.classList.remove("show")):(a.classList[E?"add":"remove"]("show"),d.classList[E?"remove":"add"]("show"))}),v,O,b,_,X,V;y.style.transform=`${L.Y}(125%)`;let Z=()=>{n.style.display="block",s.style.display="none",m.style.opacity="1",l.style.opacity="0",i.style.opacity="0",i.style.color="",y.style.transform=`${L.Y}(125%)`,a.classList.remove("show"),d.classList.remove("show"),B(!0),Ke(n)};s.addEventListener("click",async()=>{clearInterval(V),Z(),await Promise.race([D(n,"animationend"),N(250)]),b.disconnect(v.destination),O.disconnect(b),v.close(),X.getTracks().forEach(r=>r.stop())}),n.addEventListener("click",async()=>{await x.play(),await N(1600),x.volume=Te},{once:!0}),n.addEventListener("click",async()=>{t.scrollIntoView({behavior:"smooth",block:"center"}),n.style.display="none",s.style.display="block",We(s),await Promise.race([D(s,"animationend"),N(250)]),v=new AudioContext,O=v.createAnalyser(),b=v.createScriptProcessor(Ne,1,1),_=new e("default",Ne,1,v.sampleRate),_.setSilence(-55);try{X=await navigator.mediaDevices.getUserMedia({audio:!0}),v.createMediaStreamSource(X).connect(O),O.connect(b),b.connect(v.destination),m.style.opacity="0",T.style.opacity="0",l.style.opacity="1";let r=!1,E=!1,J=!1,H=!1,Q,c,z,ee=new Array(He).fill(void 0),A=new Map(f.map(u=>[u,[]])),h=new Map(f.map(u=>[u,!1])),Ae=(await D(b,"audioprocess")).inputBuffer.getChannelData(0),R=_.do(Ae);b.addEventListener("audioprocess",u=>{let M=u.inputBuffer.getChannelData(0);R=_.do(M)}),V=setInterval(()=>{var te,ne,oe,se,re,ae;if(H)return;let u=fe(R),M=u.name?`${u.name}_${u.octave}`:void 0;Ee(ee,M);let $=[...ye(ee)],F=$.filter(je);c=Ye((te=F.find(o=>o.length>K))==null?void 0:te[0]);let Ie=F.every(o=>o.length<=K),Se=[...ge(F,qe(c))].length>=3;if(Ie&&r)c=void 0,r=!1,m.style.opacity="0",l.style.opacity="1",i.style.opacity="0",i.style.color="",y.style.transform=`${L.Y}(125%)`,B(!0);else if(c&&!Number.isNaN(u.cents)&&x.paused){r=!0,E=!0;let o=c,p=R<P[o],ie=M===o?u.cents:p?-50:50,Be=Math.abs(ie)*2,Oe=Math.min(10,Math.round(100/Be)),le=he(ie,Oe),ce=(ne=A.get(o))!=null?ne:[],_e=(oe=h.get(o))!=null?oe:!1;M===o&&le===0&&ce.push(0);let k=Me(ce.length/Re),ue=le*(1-k);B(M===o&&ue===0,p),l.style.opacity="0",i.style.opacity="1";let Y=o.split("_")[0];Q!==Y&&(i.innerText=Y),Q=Y,g.style.transition=`transform ${U}ms ease`,g.style.transform=`scale(${1-k})`,i.style.transition=`color ${U}ms ease`,i.style.color=k===1?"#fbfbfb":"#fbfbfb88",y.style.transition=`transform ${U}ms ease`,y.style.transform=`${L.Y}(${-ue}%)`,k===1&&!_e&&(j((re=(se=G.get(o))==null?void 0:se.querySelector("path"))==null?void 0:re.style,"fill","rgb(67,111,142)"),j((ae=C.get(o))==null?void 0:ae.style,"display","block"),h.set(o,!0),N(U).then(()=>{x.play(),S(i,"explode"),[...C.values()].every(I=>I.style.display==="block")&&!J&&(J=!0,H=!0,t.classList.add("all-tuned-up"),i.style.opacity="0",w.style.opacity="1",S(w,"explode"),c=void 0,h=new Map(f.map(I=>[I,!1])),A=new Map(f.map(I=>[I,[]])),y.style.transform=`${L.Y}(125%)`,B(!0),N(Ve).then(()=>{H=!1,t.classList.remove("all-tuned-up"),w.style.opacity="0"}))}))}let Le=$[0][0]===void 0&&$[0].length>=2,Ce=z!==c;z=c,E&&Ce?(g.style.transition="transform 100ms",g.style.transform="scale(1)",E=!1,h=new Map(f.map(o=>{var p;return o===c?[o,(p=h.get(o))!=null?p:!1]:[o,!1]})),A=new Map(f.map(o=>{var p;return o===c?[o,(p=A.get(o))!=null?p:[]]:[o,[]]}))):E&&(Le||Se)&&(c=void 0,g.style.transition="transform 100ms",g.style.transform="scale(1)",E=!1,h=new Map(f.map(o=>[o,!1])),A=new Map(f.map(o=>[o,[]])))},Xe)}catch(r){clearInterval(V),Z(),m.style.opacity="0",T.innerText=r.message,T.style.opacity="1"}})});})();
/**
 * Copyright (C) 2021 Online Mic Test
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 * @license
 */
